<!DOCTYPE html>
<html lang="ru">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" href="./static/icon/favicon.png" type="image/x-icon">
   <link rel="stylesheet" type="text/css" href="./static/css/style.css">
   <title>Управление устройствами</title>
</head>
<body class="theme-default">
   <div class="container">
      <div class="card">
         <header>
            <h1>Управление устройствами</h1>
            <button class="refresh-btn" onclick="refreshUserList()">Обновить список пользователей</button>
         </header>

         <!-- Выбор пользователя -->
         <div class="form-group">
            <label for="userDropdown">Выберите пользователя:</label>
            <select id="userDropdown" onchange="onUserChange()">
               <option value="">--Загрузка пользователей--</option>
            </select>
         </div>

         <!-- Выбор устройства -->
         <div class="form-group">
            <label for="deviceDropdown">Выберите устройство:</label>
            <select id="deviceDropdown">
               <option value="">--Сначала выберите пользователя--</option>
            </select>
         </div>
         
         <div id="commandPanel" class="command-panel">
            <h3>Доступные команды:</h3>
            <select id="commandSelect" class="command-dropdown" onchange="handleCommandChange()">
               <option value="" selected disabled>Выберите команду...</option>
               <option value="GetState">Получить состояние</option>
               <option value="Firmware">Загрузить прошивку</option>
               <option value="UserInput">Ввести вручную</option>
           </select>
            <button id="sendCommandBtn" onclick="sendSelectedCommand()">Отправить</button>
            
            <div id="customCommandPanel">
               <h4>Ввод (JSON формат):</h4>
               <textarea id="customCommandInput" placeholder='{
                  "TypeMesseage": "YourCommand",
                  "Param1": "Value1",
                  "Param2": 123
                  }'>
               </textarea>
            </div>

            <div id="firmwareUploadPanel">
               <h4>Выберите файл прошивки:</h4>
               <input type="file" id="firmwareFile" accept=".bin">
               <button onclick="uploadFirmware()">Загрузить</button>
            </div>
         </div>
      </div>

      <div class="result-panel">
         <h1>Результат выполнения команды:</h1>
         <div id="responseOutput"></div>
         <div id="responseMeta"></div>
      </div>
   </div>

   <script>
      let selectedUser = null;
      let selectedDevice = null;
      let progressInterval = null;
      let usersList = []; // Храним список пользователей
      
      // Загрузка списка пользователей при открытии страницы
      document.addEventListener('DOMContentLoaded', function() {
         document.getElementById('commandPanel').style.display = 'none';
         document.getElementById('responseOutput').style.display = 'none';
         document.getElementById('responseMeta').style.display = 'none';
         getUserList();
      });

      // Функция обновления списка пользователей
      function refreshUserList() {
         document.getElementById('userDropdown').innerHTML = '<option value="">--Обновление списка--</option>';
         document.getElementById('deviceDropdown').innerHTML = '<option value="">--Сначала выберите пользователя--</option>';
         document.getElementById('commandPanel').style.display = 'none';
         document.getElementById('responseOutput').style.display = 'none';
         document.getElementById('responseMeta').style.display = 'none';
         getUserList();
      }

      // Обработчик изменения выбранного пользователя
      function onUserChange() {
         const userDropdown = document.getElementById('userDropdown');
         selectedUser = userDropdown.value;
         
         if (selectedUser) {
            // Находим выбранного пользователя в списке
            const user = usersList.find(u => u.Token === selectedUser);

            getDeviceList(selectedUser);
         } else {
            document.getElementById('deviceDropdown').innerHTML = '<option value="">--Сначала выберите пользователя--</option>';
            selectedDevice = null;
            document.getElementById('commandPanel').style.display = 'none';
         }
      }

      // Обработчик изменения выбранной команды
      function handleCommandChange() {
         const command = document.getElementById('commandSelect').value;
         const customPanel = document.getElementById('customCommandPanel');
         const firmwarePanel = document.getElementById('firmwareUploadPanel');
         const sendBtn = document.getElementById('sendCommandBtn');
         
         customPanel.style.display = command === "UserInput" ? 'block' : 'none';
         firmwarePanel.style.display = command === "Firmware" ? 'block' : 'none';
         sendBtn.style.display = command === "Firmware" ? 'none' : 'block';
      }

      // Функция для получения списка пользователей
      function getUserList() {
         fetch('./Admin', {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
            },
            body: JSON.stringify({
               TypeMesseage: "GetUserList"
            })
         })
         .then(response => response.json())
         .then(data => {
            usersList = data; // Сохраняем список пользователей
            updateUserDropdown(data);
         })
         .catch(error => {
            console.error('Error:', error);
            document.getElementById('userDropdown').innerHTML = '<option value="">Ошибка загрузки пользователей</option>';
         });
      }

      // Обновление выпадающего списка пользователей
      function updateUserDropdown(users) {
         const dropdown = document.getElementById('userDropdown');
         dropdown.innerHTML = '<option value="">-- Выберите пользователя --</option>';
         
         if (users && users.length > 0) {
            users.forEach(user => {
               const option = document.createElement('option');
               option.value = user.Token;
               option.textContent = user.Login;
               dropdown.appendChild(option);
            });
         } else {
            dropdown.innerHTML = '<option value="">Нет доступных пользователей</option>';
         }
      }

      // Функция для получения списка устройств
      function getDeviceList(userToken) {
         const data = {
            TypeMesseage: "GetListDevice",
            Token: userToken
         };
         
         fetch('./Admin', {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
         })
         .then(response => response.json())
         .then(data => {
            updateDeviceDropdown(data);
         })
         .catch(error => {
            console.error('Error:', error);
            document.getElementById('deviceDropdown').innerHTML = '<option value="">Ошибка загрузки устройств</option>';
         });
      }
      
      // Обновление выпадающего списка устройств
      function updateDeviceDropdown(devices) {
         const dropdown = document.getElementById('deviceDropdown');
         dropdown.innerHTML = '<option value="">-- Выберите устройство --</option>';
         
         if (devices && devices.length > 0) {
            devices.forEach(device => {
               const option = document.createElement('option');
               option.value = device.ChipId;
               option.textContent = device.DeviceName;
               dropdown.appendChild(option);
            });
         } else {
            dropdown.innerHTML = '<option value="">Нет доступных устройств</option>';
         }
         
         // Обработчик выбора устройства
         dropdown.addEventListener('change', function() {
            if (this.value) {
               selectedDevice = parseInt(this.value);
               document.getElementById('commandPanel').style.display = 'block';
               document.getElementById('commandSelect').value = "";
               document.getElementById('customCommandPanel').style.display = 'none';
               document.getElementById('firmwareUploadPanel').style.display = 'none';
               document.getElementById('sendCommandBtn').style.display = 'block';
            } else {
               selectedDevice = null;
               document.getElementById('responseOutput').style.display = 'none';
               document.getElementById('responseMeta').style.display = 'none';
               document.getElementById('commandPanel').style.display = 'none';
            }
         });
      }
      
      function sendSelectedCommand() {
         const select = document.getElementById('commandSelect');
         const command = select.value;
         
         if (!command) {
            alert("Выберите команду!");
            return;
         }
         
         // Отправка команды
         console.log("Отправка команды:", command);
         sendCommand(command);
      }

      // Функция загрузки прошивки
      function uploadFirmware() {
         if (!selectedDevice) {
            alert("Сначала выберите устройство!");
            return;
         }
         
         const fileInput = document.getElementById('firmwareFile');
         if (!fileInput.files || fileInput.files.length === 0) {
            alert("Выберите файл прошивки!");
            return;
         }
         
         const file = fileInput.files[0];
         if (!file.name.endsWith('.bin')) {
            alert("Формат файла должен быть .bin!");
            return;
         }
         
         // Создаем элемент для отображения прогресса
         const progressHTML = `
            <div id="firmwareProgress">
               <div class="progress-container">
                  <div class="progress-bar" style="width: 0%"></div>
               </div>
               <div class="progress-text">0%</div>
               <div class="progress-status">Подготовка к обновлению...</div>
            </div>
         `;
         
         document.getElementById('responseOutput').innerHTML = progressHTML;
         document.getElementById('responseOutput').style.display = 'block';
         document.getElementById('responseMeta').style.display = 'none';
         
         const formData = new FormData();
         formData.append('firmware', file);
         formData.append('ChipId', selectedDevice.toString());
         
         fetch('./Device/OTA', {
            method: 'POST',
            body: formData
         })
         .then(response => response.text())
         .then(text => {
            try {
               const data = JSON.parse(text);
               if (data.status === 'success') {
                  // Начинаем отслеживание прогресса
                  startProgressPolling(selectedDevice);
               }
            } catch (e) {
               console.error('Error parsing response:', e);
            }
         })
         .catch(error => {
            console.error('Upload error:', error);
            clearInterval(progressInterval);
            document.querySelector('.progress-status').textContent = `Ошибка: ${error.message}`;
         });
      }

      // Функция для опроса статуса прошивки
      function startProgressPolling(chipId) {
         // Очищаем предыдущий интервал, если он был
         if (progressInterval) {
            clearInterval(progressInterval);
         }
         
         // Опрашиваем сервер каждую секунду
         progressInterval = setInterval(() => {
            const data = {
               TypeMesseage: "GetProgress",
               ChipId: chipId
            };
            
            fetch('./Admin', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
               const progress = data.progress || 0;
               const status = data.status || 'unknown';
               
               // Обновляем UI
               if (document.querySelector('.progress-bar')) {
                  document.querySelector('.progress-bar').style.width = `${progress}%`;
                  document.querySelector('.progress-text').textContent = `${progress}%`;
                  
                  let statusText = "В процессе...";
                  if (status === 'completed') {
                     statusText = "Обновление завершено";
                     clearInterval(progressInterval);
                  } else if (status === 'failed') {
                     statusText = "Ошибка обновления";
                     clearInterval(progressInterval);
                  } else if (status === 'error') {
                     statusText = `Ошибка: ${data.message || 'неизвестная ошибка'}`;
                     clearInterval(progressInterval);
                  }
                  
                  document.querySelector('.progress-status').textContent = statusText;
               }
            })
            .catch(error => {
               console.error('Error fetching progress:', error);
               if (document.querySelector('.progress-status')) {
                  document.querySelector('.progress-status').textContent = `Ошибка получения прогресса: ${error.message}`;
               }
            });
         }, 2000);
      }

      // Общая функция отправки команд
      function sendCommand(commandType) {
         if (!selectedDevice) {
            alert("Сначала выберите устройство!");
            return;
         }
         
         const startTime = new Date(); // Засекаем время начала запроса
         let data = {};
         let requestData = {};

         var EndPoint = './Device/SendMesseage';

         if (commandType === "UserInput") {
            try {
               const customInput = document.getElementById('customCommandInput').value;
               if (!customInput.trim()) {
                  alert("Введите команду в JSON формате!");
                  return;
               }
               
               data = JSON.parse(customInput);
               // Добавляем ChipId, если его нет в введенных данных
               if (!data.ChipId) data.ChipId = selectedDevice;

               requestData = data;

               if (data.TypeMesseage === "UpdateNameController") EndPoint = './Admin'
               if (data.TypeMesseage === "GetIpDevice")          EndPoint = './Admin'

            } catch (e) {
               alert("Ошибка в формате JSON: " + e.message);
               return;
            }
         }
         else {
            requestData = {
               ChipId: selectedDevice,
               TypeMesseage: commandType
            };
         }
         
         fetch(EndPoint, {
            method: 'POST',
            headers: {
               'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
         })
         .then(response => response.json())
         .then(data => {
            const endTime = new Date(); // Засекаем время получения ответа
            const duration = endTime - startTime; // Вычисляем длительность
            
            console.log('Success:', data);
            displayResponse(data, duration);
         })
         .catch(error => {
            const endTime = new Date();
            const duration = endTime - startTime;
            
            console.error('Error:', error);
            displayResponse({error: error.message}, duration);
         });
      }

      // Функция для отображения ответа
      function displayResponse(data, duration) {
         document.getElementById('responseMeta').style.display = 'block';
         document.getElementById('responseOutput').style.display = 'block';
         const output = document.getElementById('responseOutput');
         const meta = document.getElementById('responseMeta');
         
         output.textContent = JSON.stringify(data, null, 2);
         
         // Форматируем дату и время
         const now = new Date();
         const timeString = now.toLocaleTimeString();
         const dateString = now.toLocaleDateString();
         
         meta.innerHTML = `
            <div>Время выполнения: ${duration} мс</div>
            <div>Запрос выполнен: ${dateString} в ${timeString}</div>
         `;
      }
   </script>
</body>
</html>